blueprint:
  name: TRV Calibrator
  description: Calibrate your TRV using an external sensor
  domain: automation
  input:
    trv:
      name: Smart TRV
      selector:
        entity:
          domain: climate
    temperature_sensor:
      name: Temperature Sensor
      description: Sensor used to calibrate your TRV
      selector:
        entity:
          domain: sensor
          device_class: temperature
    trv_calibration_number:
      name: TRV Calibration Entity
      description: If you can't find it it's possible that your TRV don't support calibration. Consider using the Better Thermostat custom integration instead.
      selector:
        entity:
          domain: number
          device_class: temperature

mode: single

variables:
  trv: !input trv
  trv_calibration_number: !input trv_calibration_number
  temperature_sensor: !input temperature_sensor

trigger_variables:
  trigger_trv: !input trv
  trigger_temperature_sensor: !input temperature_sensor

trigger:
  - platform: template
    value_template: >-
      {{ ((
      ((state_attr(trigger_trv,'current_temperature')  | default (-1))
      - 
      (states(trigger_temperature_sensor) | float (-1))
      )) | abs ) > 0.5
      }}

condition:
  - condition: template
    value_template: >-
      {{state_attr(trv,'current_temperature') | default
      (-1) != -1}}
  - condition: template
    value_template: "{{states(temperature_sensor) | float (-1) != -1}}"

action:
  - variables:
      temp_diff: >-
        {{states(temperature_sensor) | float -
        state_attr(trv,'current_temperature' )}}
  - if:
      - condition: template
        value_template: "{{temp_diff | abs >0.5}}"
    then:
      - service: number.set_value
        metadata: {}
        data:
          value: >-
            {{temp_diff +
            states(trv_calibration_number)|
            float}}
        target:
          entity_id: !input trv_calibration_number
